name: Deploy to OCI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to OCI
      env:
        OCI_HOST: ${{ secrets.OCI_HOST }}
        OCI_USER: ${{ secrets.OCI_USERNAME }}
        OCI_SSH_KEY: ${{ secrets.OCI_SSH_KEY }}
      run: |
        # Verificar secrets
        if [ -z "$OCI_HOST" ] || [ -z "$OCI_USER" ] || [ -z "$OCI_SSH_KEY" ]; then
          echo "âŒ Secrets nÃ£o configuradas."
          exit 1
        fi
        
        # Configurar SSH
        mkdir -p ~/.ssh
        echo "$OCI_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Script de Deploy
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        set -e
        
        PROJECT_DIR="/var/www/Barbear.IA"
        REPO_URL="https://github.com/guelfi/Barbear.IA.git"
        
        echo "ðŸš€ Iniciando deploy do Barbear.IA..."
        
        # Criar diretÃ³rio se nÃ£o existir
        sudo mkdir -p /var/www
        
        # Clone ou Pull
        if [ ! -d "$PROJECT_DIR" ]; then
          echo "ðŸ“ Clonando repositÃ³rio..."
          cd /var/www
          sudo git clone $REPO_URL
          sudo chown -R ubuntu:ubuntu $PROJECT_DIR
          cd $PROJECT_DIR
        else
          echo "ðŸ“ Atualizando repositÃ³rio..."
          cd $PROJECT_DIR
          sudo git fetch origin
          sudo git reset --hard origin/main
        fi
        
        # Fazer backup da versÃ£o atual
        if [ -d "build" ]; then
          echo "ðŸ“¦ Fazendo backup da versÃ£o atual..."
          sudo mv build build_backup_$(date +%Y%m%d_%H%M%S) || true
        fi
        
        # Parar containers existentes
        echo "ðŸ›‘ Parando containers existentes..."
        sudo docker-compose down || true
        sudo docker stop barbear-ia-frontend || true
        sudo docker rm barbear-ia-frontend || true
        
        # Limpar imagens antigas
        echo "ðŸ§¹ Limpando imagens antigas..."
        sudo docker image prune -f || true
        
        # Verificar e instalar Node.js se necessÃ¡rio
        if ! command -v npm &> /dev/null; then
          echo "ðŸ“¦ Node.js nÃ£o encontrado, instalando..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          echo "âœ… Node.js $(node --version) e npm $(npm --version) instalados"
        else
          echo "âœ… Node.js $(node --version) e npm $(npm --version) jÃ¡ instalados"
        fi
        
        # Instalar dependÃªncias e build
        echo "ðŸ”¨ Fazendo build da aplicaÃ§Ã£o..."
        rm -rf node_modules package-lock.json
        npm install
        npm run build
        
        # Garantir que Dockerfile e Compose existam
        if [ ! -f "Dockerfile" ]; then
            echo "âš ï¸ Criando Dockerfile..."
            cat > Dockerfile << 'DOCKERFILE'
# Build stage
FROM node:18-alpine AS builder

WORKDIR /app

# Instalar versÃ£o estÃ¡vel do npm
RUN npm install -g npm@10

# Copy package files
COPY package*.json ./

# Instalar dependÃªncias
RUN echo "ðŸ“¦ Removendo package-lock.json e usando npm install limpo" && \
    rm -f package-lock.json && \
    npm install --no-audit --no-fund

# Copy source code
COPY . .

# Build the application
RUN echo "ðŸ—ï¸ Iniciando build de produÃ§Ã£o..." && \
    npm run build && \
    echo "âœ… Build concluÃ­do. Verificando arquivos gerados:" && \
    ls -la build/

# Production stage
FROM nginx:alpine

# Copy built application
COPY --from=builder /app/build /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expose port 80
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
DOCKERFILE
        fi
        
        if [ ! -f "docker-compose.yml" ]; then
            echo "âš ï¸ Criando docker-compose.yml..."
            cat > docker-compose.yml << 'COMPOSE'
version: '3.3'

services:
  barbear-ia-frontend:
    build: .
    container_name: barbear-ia-frontend
    ports:
      - "3500:80"
    networks:
      - barbear-ia-net
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
    restart: unless-stopped

networks:
  barbear-ia-net:
    driver: bridge
COMPOSE
        fi

        # Deploy
        echo "ðŸ³ Reconstruindo e iniciando..."
        sudo docker-compose up -d --build
        
        # VerificaÃ§Ã£o
        echo "ðŸ” Verificando status..."
        sleep 10
        if sudo docker ps | grep -q barbear-ia-frontend; then
            echo "âœ… Barbear.IA rodando na porta 3500!"
            echo "ðŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://$(curl -s ifconfig.me):3500"
            sudo docker logs barbear-ia-frontend --tail 20
        else
            echo "âŒ Falha ao iniciar Barbear.IA."
            sudo docker logs barbear-ia-frontend || true
            exit 1
        fi
        
        # Limpeza
        sudo docker system prune -f
        echo "ðŸŽ‰ Deploy concluÃ­do!"
        EOF
        
        # Executar remotamente
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no deploy_script.sh "$OCI_USER@$OCI_HOST:/tmp/"
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no "$OCI_USER@$OCI_HOST" "chmod +x /tmp/deploy_script.sh && /tmp/deploy_script.sh"