name: Deploy Barbear.IA to OCI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  PROJECT_NAME: Barbear.IA
  CONTAINER_NAME: barbear-ia-frontend
  PORT: 3500

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint || echo "Linting completed with warnings"
    
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
    
    - name: Build application
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build/
        retention-days: 1

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Sync project files to OCI
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USERNAME }}
        key: ${{ secrets.OCI_SSH_KEY }}
        script: |
          echo "ğŸš€ Iniciando sincronizaÃ§Ã£o do ${{ env.PROJECT_NAME }}..."
          
          # Create project directory if not exists
          sudo mkdir -p /var/www/${{ env.PROJECT_NAME }}
          sudo chown ubuntu:ubuntu /var/www/${{ env.PROJECT_NAME }}
          cd /var/www/${{ env.PROJECT_NAME }}
          
          # Backup current setup
          if [ -f docker-compose.yml ]; then
            echo "ğŸ“¦ Criando backup da configuraÃ§Ã£o atual..."
            cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # Download essential project files from GitHub
          echo "ğŸ“¥ Baixando arquivos do repositÃ³rio..."
          
          # Function to download file with error handling
          download_file() {
            local file=$1
            echo "Baixando $file..."
            if curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3.raw" \
                    -o "$file" \
                    -L "https://api.github.com/repos/${{ github.repository }}/contents/$file" \
                    --fail --silent --show-error; then
              echo "âœ… $file baixado com sucesso"
            else
              echo "âŒ Erro ao baixar $file"
              return 1
            fi
          }
          
          # Download required files
          download_file "docker-compose.yml"
          download_file "Dockerfile"
          download_file "nginx.conf"
          download_file "package.json"
          download_file ".dockerignore"
          
          echo "âœ… SincronizaÃ§Ã£o de arquivos concluÃ­da"

    - name: Deploy to OCI with Zero Downtime
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USERNAME }}
        key: ${{ secrets.OCI_SSH_KEY }}
        script: |
          cd /var/www/${{ env.PROJECT_NAME }}
          
          echo "ğŸ”„ Iniciando deploy do ${{ env.PROJECT_NAME }}..."
          
          # Check if container is currently running
          CONTAINER_RUNNING=$(docker-compose ps -q ${{ env.CONTAINER_NAME }} 2>/dev/null)
          
          if [ ! -z "$CONTAINER_RUNNING" ]; then
            echo "ğŸ“Š Container atual detectado, preparando para atualizaÃ§Ã£o..."
            
            # Health check before deploy
            if curl -f http://localhost:${{ env.PORT }}/ > /dev/null 2>&1; then
              echo "âœ… AplicaÃ§Ã£o atual estÃ¡ saudÃ¡vel"
            else
              echo "âš ï¸ AplicaÃ§Ã£o atual nÃ£o estÃ¡ respondendo"
            fi
          fi
          
          # Build new image with cache optimization
          echo "ğŸ—ï¸ Construindo nova imagem..."
          docker-compose build --no-cache ${{ env.CONTAINER_NAME }}
          
          if [ $? -ne 0 ]; then
            echo "âŒ Erro no build da imagem"
            exit 1
          fi
          
          # Stop current container gracefully
          if [ ! -z "$CONTAINER_RUNNING" ]; then
            echo "ğŸ›‘ Parando container atual..."
            docker-compose stop ${{ env.CONTAINER_NAME }}
          fi
          
          # Start new version
          echo "ğŸš€ Iniciando nova versÃ£o..."
          docker-compose up -d ${{ env.CONTAINER_NAME }}
          
          # Wait for container to be ready
          echo "â³ Aguardando inicializaÃ§Ã£o (30 segundos)..."
          sleep 30
          
          # Health check with retry
          echo "ğŸ” Executando health check..."
          RETRY_COUNT=0
          MAX_RETRIES=5
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:${{ env.PORT }}/ > /dev/null 2>&1; then
              echo "âœ… Health check passou! AplicaÃ§Ã£o estÃ¡ funcionando"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "â³ Tentativa $RETRY_COUNT/$MAX_RETRIES falhou, aguardando 10 segundos..."
              sleep 10
            fi
          done
          
          # Final health check
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ Health check falhou apÃ³s $MAX_RETRIES tentativas"
            echo "ğŸ“‹ Logs do container:"
            docker-compose logs --tail=20 ${{ env.CONTAINER_NAME }}
            
            echo "ğŸ”„ Tentando rollback..."
            docker-compose down
            
            # Restore from backup if available
            if [ -f docker-compose.yml.backup.* ]; then
              latest_backup=$(ls -t docker-compose.yml.backup.* | head -1)
              echo "ğŸ“¦ Restaurando backup: $latest_backup"
              cp "$latest_backup" docker-compose.yml
              docker-compose up -d ${{ env.CONTAINER_NAME }}
              sleep 15
              
              if curl -f http://localhost:${{ env.PORT }}/ > /dev/null 2>&1; then
                echo "âœ… Rollback realizado com sucesso"
              else
                echo "âŒ Rollback tambÃ©m falhou"
              fi
            fi
            exit 1
          fi
          
          # Show final status
          echo "ğŸ“Š Status final dos containers:"
          docker-compose ps
          
          echo "ğŸ§¹ Limpando imagens nÃ£o utilizadas..."
          docker image prune -f
          
          echo "ğŸ‰ Deploy do ${{ env.PROJECT_NAME }} realizado com sucesso!"
          echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://${{ secrets.OCI_HOST }}:${{ env.PORT }}"