name: ğŸš€ Deploy Simples Barbear.IA

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'ForÃ§ar rebuild completo'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy:
    name: ğŸ“¦ Deploy para OCI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci
    
    - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
      run: npm run build
    
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.OCI_HOST }}
        username: ${{ secrets.OCI_USERNAME }}
        key: ${{ secrets.OCI_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸ”„ Iniciando deploy simples..."
          
          # Navegar para o diretÃ³rio do projeto
          cd /var/www/Barbear.IA || { echo "âŒ DiretÃ³rio nÃ£o encontrado"; exit 1; }
          
          # Parar container atual se existir
          if docker-compose ps | grep -q barbear-ia-frontend; then
            echo "â¹ï¸ Parando container atual..."
            docker-compose down
          fi
          
          # Fazer backup do cÃ³digo atual
          if [ -d "backup" ]; then
            rm -rf backup.old
            mv backup backup.old
          fi
          mkdir -p backup
          cp -r dist backup/ 2>/dev/null || echo "â„¹ï¸ Nenhum dist anterior para backup"
          
          # Atualizar cÃ³digo do repositÃ³rio
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/main
          
          # Rebuild apenas se solicitado
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ”¨ Rebuild forÃ§ado - removendo imagens..."
            docker-compose down --rmi all --volumes --remove-orphans || true
            docker system prune -f || true
          fi
          
          # Subir a aplicaÃ§Ã£o
          echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
          docker-compose up -d --build
          
          # Aguardar alguns segundos para inicializaÃ§Ã£o
          sleep 10
          
          # Verificar se estÃ¡ funcionando
          if curl -f -s http://localhost:3500/ > /dev/null; then
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://localhost:3500"
          else
            echo "âŒ Falha na verificaÃ§Ã£o de saÃºde"
            echo "ğŸ”„ Tentando rollback..."
            
            # Rollback simples
            docker-compose down
            if [ -d "backup/dist" ]; then
              rm -rf dist
              cp -r backup/dist .
              docker-compose up -d
              echo "ğŸ”„ Rollback executado"
            fi
            exit 1
          fi
          
          # Limpeza bÃ¡sica
          docker image prune -f || true
          
          echo "ğŸ‰ Deploy finalizado!"

    - name: ğŸ”” Notificar resultado
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deploy realizado com sucesso!"
        else
          echo "âŒ Deploy falhou - verifique os logs"
        fi